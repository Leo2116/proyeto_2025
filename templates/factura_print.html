<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Factura {{ fac.numero_factura }}</title>
  <script>
    // Inicializa tema global para evitar parpadeo
    try {
      const t = localStorage.getItem('theme');
      const prefersDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
      document.documentElement.setAttribute('data-theme', t || (prefersDark ? 'dark' : 'light'));
    } catch (e) {}
  </script>
  <style>
    :root{ --text:#111; --muted:#666; --border:#ddd; --bg:#fff; --th-bg:#f5f5f5; }
    :root[data-theme="dark"]{ --text:#e5e7eb; --muted:#9ca3af; --border:#374151; --bg:#0b1220; --th-bg:#111827; }
    body{ font-family: Arial, Helvetica, sans-serif; color:var(--text); background: var(--bg); margin:20px; }
    .wrap{ max-width: 820px; margin: 0 auto; }
    header{ display:flex; align-items:center; justify-content:space-between; margin-bottom:18px; }
    h1{ font-size:1.4rem; margin:0; }
    .meta{ font-size:.9rem; color:var(--muted); }
    table{ width:100%; border-collapse:collapse; }
    th, td{ border:1px solid var(--border); padding:8px; }
    th{ background:var(--th-bg); text-align:left; color: var(--text); }
    tfoot td{ font-weight:bold; }
    .actions{ margin:14px 0; }
    .actions button{ padding:.5rem .8rem; margin-right:.5rem; }
    @media print{
      .actions{ display:none; }
      body{ margin:0; }
    }
  </style>
  <script>
    function downloadJSON(){
      try{
        const data = {
          id: {{ fac.id | tojson }},
          numero_factura: {{ fac.numero_factura | tojson }},
          nit: {{ (fac.nit or 'C/F') | tojson }},
          pago_metodo: {{ (fac.pago_metodo or '-') | tojson }},
          entrega_metodo: {{ (fac.entrega_metodo or '-') | tojson }},
          envio_nombre: {{ (fac.envio_nombre or '') | tojson }},
          envio_telefono: {{ (fac.envio_telefono or '') | tojson }},
          envio_direccion: {{ (fac.envio_direccion or '') | tojson }},
          total: {{ (fac.total or 0) | tojson }},
          fecha: {{ (fac.fecha.isoformat() if fac.fecha else None) | tojson }},
          items: [
            {% for i in items %}
            {{ {
              'producto_id': i.producto_id,
              'nombre': i.nombre,
              'precio': i.precio or 0,
              'cantidad': i.cantidad or 1,
              'subtotal': i.subtotal or 0
            } | tojson }}{% if not loop.last %},{% endif %}
            {% endfor %}
          ]
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:'application/json'});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = (data.numero_factura || 'factura') + '.json';
        document.body.appendChild(a); a.click();
        setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 300);
      }catch(e){ console.error(e); }
    }
  </script>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>Factura {{ fac.numero_factura }}</h1>
        <div class="meta">Fecha: {{ fac.fecha.strftime('%Y-%m-%d %H:%M') if fac.fecha else '' }}</div>
      </div>
      <div class="meta">
        <div>NIT: {{ fac.nit or 'C/F' }}</div>
        <div>Pago: {{ fac.pago_metodo or '-' }}</div>
        <div>Entrega: {{ fac.entrega_metodo or '-' }}</div>
      </div>
    </header>

    {% if fac.entrega_metodo == 'domicilio' %}
    <section style="margin-bottom:12px">
      <strong>Datos de entrega</strong><br>
      {{ fac.envio_nombre or '' }}<br>
      {{ fac.envio_telefono or '' }}<br>
      {{ fac.envio_direccion or '' }}
    </section>
    {% endif %}

    <table>
      <thead>
        <tr><th>Producto</th><th style="width:110px">Precio</th><th style="width:90px">Cant.</th><th style="width:120px">Subtotal</th></tr>
      </thead>
      <tbody>
        {% for it in items %}
        <tr>
          <td>{{ it.nombre }}</td>
          <td style="text-align:right">Q{{ '%.2f'|format(it.precio or 0) }}</td>
          <td style="text-align:center">{{ it.cantidad or 1 }}</td>
          <td style="text-align:right">Q{{ '%.2f'|format(it.subtotal or 0) }}</td>
        </tr>
        {% endfor %}
      </tbody>
      <tfoot>
        <tr><td colspan="3" style="text-align:right">Total</td><td style="text-align:right">Q{{ '%.2f'|format(fac.total or 0) }}</td></tr>
      </tfoot>
    </table>

    <div class="actions">
      <button onclick="window.print()">Imprimir / Guardar PDF</button>
      <button onclick="downloadJSON()">Descargar JSON</button>
      <button id="theme-btn" onclick="(function(){ const cur = document.documentElement.getAttribute('data-theme')==='dark'?'light':'dark'; document.documentElement.setAttribute('data-theme',cur); try{ localStorage.setItem('theme',cur);}catch(e){}; document.getElementById('theme-btn').textContent = cur==='dark' ? 'Modo claro' : 'Modo oscuro'; })()">Modo oscuro</button>
    </div>
  </div>
</body>
</html>
